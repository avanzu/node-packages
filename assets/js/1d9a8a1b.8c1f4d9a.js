"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[170],{6666:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"kernel/kernel/the-kernel","title":"The Kernel","description":"The Kernel class is the orchestration layer of your application. It serves as the entry point that initializes the container, prepares the Koa application, wires up middleware, and loads your controller routes.","source":"@site/docs/kernel/2000-kernel/1002-the-kernel.md","sourceDirName":"kernel/2000-kernel","slug":"/kernel/kernel/the-kernel","permalink":"/node-packages/docs/kernel/kernel/the-kernel","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1002,"frontMatter":{"title":"The Kernel","sidebar_label":"The Kernel"},"sidebar":"kernelSidebar","previous":{"title":"Owning Your Application Types","permalink":"/node-packages/docs/kernel/kernel/owning-your-types"},"next":{"title":"Bootstrapping","permalink":"/node-packages/docs/kernel/kernel/bootstrapping"}}');var s=r(4848),t=r(8453);const o={title:"The Kernel",sidebar_label:"The Kernel"},l=void 0,a={},d=[{value:"Responsibilities",id:"responsibilities",level:2},{value:"Key Lifecycle Methods",id:"key-lifecycle-methods",level:2},{value:"Subclass Responsibilities",id:"subclass-responsibilities",level:2},{value:"Middleware Hook",id:"middleware-hook",level:2},{value:"Internal Middleware Stack",id:"internal-middleware-stack",level:3},{value:"Controller Discovery",id:"controller-discovery",level:2},{value:"Container Creation",id:"container-creation",level:2},{value:"Example subclass",id:"example-subclass",level:2}];function c(e){const n={code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"Kernel"})," class is the orchestration layer of your application. It serves as the entry point that initializes the container, prepares the Koa application, wires up middleware, and loads your controller routes."]}),"\n",(0,s.jsxs)(n.p,{children:["This class is ",(0,s.jsx)(n.strong,{children:"abstract"}),", meaning it must be subclassed in the application to implement some required behavior, namely how the container and logger are created."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"responsibilities",children:"Responsibilities"}),"\n",(0,s.jsx)(n.p,{children:"The Kernel is responsible for:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Instantiating the application (",(0,s.jsx)(n.code,{children:"Koa"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:["Creating the dependency injection container (",(0,s.jsx)(n.code,{children:"awilix"}),")"]}),"\n",(0,s.jsx)(n.li,{children:"Registering application middlewares"}),"\n",(0,s.jsx)(n.li,{children:"Loading annotated controllers"}),"\n",(0,s.jsx)(n.li,{children:"Booting and serving the application"}),"\n",(0,s.jsx)(n.li,{children:"Shutting down resources cleanly"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"key-lifecycle-methods",children:"Key Lifecycle Methods"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"async boot(): Promise<void>\n"})}),"\n",(0,s.jsx)(n.p,{children:"Initializes the DI container and middleware stack. Also loads all registered controllers."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"async serve(): Promise<Server>\n"})}),"\n",(0,s.jsx)(n.p,{children:"Starts the server using host and port options from the runtime config."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"async shutdown(): Promise<void>\n"})}),"\n",(0,s.jsx)(n.p,{children:"Disposes of the container and gracefully shuts down the HTTP server if it was started."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"subclass-responsibilities",children:"Subclass Responsibilities"}),"\n",(0,s.jsx)(n.p,{children:"Your application must subclass Kernel and implement the following methods:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"createContainerBuilder(): ContainerBuilder\n"})}),"\n",(0,s.jsx)(n.p,{children:"Return an instance of your container builder that knows how to register modules into the DI container."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"createLogger(): Logger\n"})}),"\n",(0,s.jsx)(n.p,{children:"Return a logger instance (used for boot, runtime, error logging, etc.)"}),"\n",(0,s.jsx)(n.h2,{id:"middleware-hook",children:"Middleware Hook"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"protected middlewares(): Middleware[]\n"})}),"\n",(0,s.jsx)(n.p,{children:"Return an array of Koa-compatible middleware to be mounted after core middlewares (error handling, authentication, and DI scope binding)."}),"\n",(0,s.jsx)(n.h3,{id:"internal-middleware-stack",children:"Internal Middleware Stack"}),"\n",(0,s.jsx)(n.p,{children:"These middlewares are always applied first:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"errorHandler()"})," \u2014 catch unhandled errors and log them"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"authenticateAnonymous()"})," \u2014 establish a default user context"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"containerScope()"})," \u2014 bind the request lifecycle to the container"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Then any user-defined middlewares from the subclass override are added."}),"\n",(0,s.jsx)(n.h2,{id:"controller-discovery",children:"Controller Discovery"}),"\n",(0,s.jsxs)(n.p,{children:["During ",(0,s.jsx)(n.code,{children:"boot()"}),", the kernel calls ",(0,s.jsx)(n.code,{children:"loadControllers()"}),".\nThis function mounts any routes found via the ",(0,s.jsx)(n.code,{children:"@Controller"})," decorator, assuming the controller classes were already imported (e.g., via a barrel file)."]}),"\n",(0,s.jsxs)(n.p,{children:["The route prefix is determined from the configuration value of ",(0,s.jsx)(n.code,{children:"namespace"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"container-creation",children:"Container Creation"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"protected createContainer(): Container\n"})}),"\n",(0,s.jsx)(n.p,{children:"Creates the base Awilix container with CLASSIC injection mode and strict resolution. Override only if you need custom container behavior."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"protected async buildContainer(): Promise<void>\n"})}),"\n",(0,s.jsx)(n.p,{children:"Uses the ContainerBuilder pattern to load and register modules. Each module should declare its expected imports and provided exports."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"example-subclass",children:"Example subclass"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"import * as Kernel from '@avanzu/kernel'\nimport { App, Configuration, Container } from './interfaces'\nimport { ContainerBuilder } from './dependencyInjection'\nimport { bodyParser } from '@koa/bodyparser'\nimport { errorHandler, normalizeUrlPath } from './middleware';\nimport pino from 'pino';\nexport class AppKernel extends Kernel.Kernel<Configuration, App, Container> {\n\n    protected loadControllers() {\n        const prefix = this.options.get('namespace') ?? '';\n\n        const router = Kernel.mountControllers(prefix.length ? `/${prefix}` : '');\n        this.app.use(router.routes());\n    }\n\n    protected createContainerBuilder(): Kernel.ContainerBuilder<Container> {\n        return new ContainerBuilder(this.options, this.logger)\n    }\n\n    protected createLogger(): Kernel.Logger {\n        const options = this.options.get('logger')\n        const appName = this.options.get('appName')\n\n        return new Kernel.PinoLogger({\n            formatters: {\n                level: (label) => ({ severity: label.toUpperCase() }),\n                bindings: (bindings) => ({ ...bindings, appName  })\n            },\n            timestamp: pino.stdTimeFunctions.isoTime,\n            ...options\n        })\n    }\n\n    protected middlewares(): Kernel.AppMiddleware<any, any, any>[] {\n        return [ bodyParser(), normalizeUrlPath(), errorHandler(['/health']) ]\n    }\n\n}\n"})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>l});var i=r(6540);const s={},t=i.createContext(s);function o(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);